<!doctype html>
<HTML lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bastion - Noms</title>
    <link rel="stylesheet" href="./style.css">
    <script type="text/javascript" src="NameGenerator.js"></script>

    <script>
        const url = new URL(window.location.href)
        const searchParams = url.searchParams;

        var selectedLanguage;

        function pushNewUrl() {
            history.pushState("namegenerator", "", "names.html?language=" + selectedLanguage.id + "&mode=" + getMode());
        }

        function getRequestDescription(language, mode) {
            var word = language;
            
            if (selectedLanguage)
                word += " (" + selectedLanguage.modes[mode].name + ")";

            return word;
        }

        function updateNames() {
            if (selectedLanguage == null)
                return; 

            var noms = "";
            for (var i = 0; i < 25 * 3; i++) {
                //noms += getName(language) + "<br>"; 
                noms += getNameModed(selectedLanguage.id, getMode()) + "<br>";
            }

            document.getElementById("names").innerHTML = noms;
        }

        function changeMode() {
            searchParams.set("language", selectedLanguage.id);
            searchParams.set("mode", getMode());
            pushNewUrl();
        }

        function changeLanguage(languageId) {
            if (selectedLanguage == getLanguage(languageId)) {
                updateNames();
                return;
            }

            let prevModeName = "";
            if (selectedLanguage != null)
            {
                // On déselectionne le bouton
                document.getElementById(selectedLanguage.id + "btn").classList.remove("selected");

                // On mémorise le nom du mode
                prevModeName = selectedLanguage.modes[getMode()].name;
            }

            selectedLanguage = getLanguage(languageId);
            document.getElementById("mode").value = 0;
            console.log("Language changed : " + getRequestDescription(languageId, getMode()));

            if (selectedLanguage == null)
            {
                document.getElementById("currentLanguage").innerHTML = "Erreur";
                document.getElementById("languageHelp").href = "languages.html";
            }
            else
            {
                document.getElementById("currentLanguage").innerHTML = selectedLanguage.name;
                document.getElementById("languageHelp").href = "languages.html#" + selectedLanguage.id;

                // On réinitialize les modes
                select = document.getElementById("mode");
                while(select.childElementCount > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // On ajoute les modes
                for (let i = 1; i < selectedLanguage.modes.length; i++) {
                    let opt = select.appendChild(document.createElement("option"));
                    opt.innerHTML = selectedLanguage.modes[i].name;
                    opt.value = i;

                    // Si on trouve un mode similaire on le récupère
                    // #TODO : c'est nul il faudrait un système plus poussé pour reconnaitre les modes :c
                    if (selectedLanguage.modes[i].name == prevModeName) {
                        document.getElementById("mode").value = i;
                    }
                }
            }

            // Sélectionne le bouton
            document.getElementById(selectedLanguage.id + "btn").classList.add("selected");

            pushNewUrl();

            updateNames();
        }

        function getMode() {
            return document.getElementById("mode").value;
        }

        function setupLanguages() {
            languages.forEach(x => addLanguage(x));
        }

        function addLanguage(lang) {
            let langs = document.getElementById("languages");
            let button = langs.appendChild(document.createElement("button"));
            button.setAttribute("onclick", "changeLanguage('" + lang.id + "')");
            button.setAttribute("class", "languagebutton");
            button.setAttribute("id", lang.id + "btn");
            button.innerHTML = lang.name;
        }

        function offsetMode(offset) {
            document.getElementById("mode").value = niceModulo(parseInt(document.getElementById("mode").value) + offset, selectedLanguage.modes.length);
            pushNewUrl();
            updateNames();
        }

        function nextMode() {
            offsetMode(1);
        }

        function prevMode() 
        {
            offsetMode(-1);
        }

        //==========//
        // KEYBOARD //
        //==========//

        const KEYDOWN = {}
        KEYDOWN.r = () => updateNames();
        KEYDOWN[' '] = () => updateNames();
        KEYDOWN.ArrowLeft = () => changeLanguage(getLanguageIndexed(selectedLanguage, -1).id);
        KEYDOWN.ArrowRight = () => changeLanguage(getLanguageIndexed(selectedLanguage, 1).id);
        KEYDOWN.ArrowDown = () => offsetMode(1);
        KEYDOWN.ArrowUp = () => offsetMode(-1);

    </script>
</head>
<body>
    <div id="header">
        <a href="index.html"><span id="title">Bastion</span></a>    <span id="author">par Victor Fanton</span>
        <hr>
    </div>
    <h1 id="currentLanguage">Langue</h1>
    <div id="nameoptions">
        <div id="languages">
        </div>
        </br>
        <select name="mode" id="mode" onchange="updateNames(), changeMode()">
            <option value=0>Default</option>
        </select>
    </div>
    <p id="names">Noms</p>
    <div style="text-align: center;">
        <a id="languageHelp" href="languages.html" target="_blank" rel="noopener noreferrer">Aide de prononciation</a>
    </div>
</body>
<script>
    setupLanguages();
    if (searchParams.has("language")) {
        changeLanguage(searchParams.get("language"));
    } else {
        changeLanguage(getRandomLanguage().id);
    }
    
    if (searchParams.has("mode")) {
        document.getElementById("mode").value = searchParams.get("mode");
        pushNewUrl();
    } else {
        document.getElementById("mode").value = 0;
    }
    updateNames();

    // KEYBOARD SETUP
    document.body.onkeydown = (e) => {
            const keydown = KEYDOWN[e.key]
            if (keydown !== undefined) keydown(e)
            else console.log("unhandled input %o", e);
        };
</script>
</HTML>