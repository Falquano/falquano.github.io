<!doctype html>
<HTML lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bastion - Noms</title>
    <link rel="stylesheet" href="./style.css">
    <script type="text/javascript" src="NameGenerator.js"></script>

    <script>
        const url = new URL(window.location.href)
        const searchParams = url.searchParams;

        var selectedLanguage;

        function pushNewUrl() {
            history.pushState("namegenerator", "", "names.html?language=" + selectedLanguage.id + "&mode=" + getMode());
        }

        function getRequestDescription(language, mode) {
            var word = language;
            
            if (selectedLanguage)
                word += " (" + selectedLanguage.modes[mode].name + ")";

            return word;
        }

        function updateNames() {
            if (selectedLanguage == null)
                return; 

            var noms = "";
            for (var i = 0; i < 25 * 3; i++) {
                //noms += getName(language) + "<br>"; 
                noms += getNameModed(selectedLanguage.id, getMode()) + "<br>";
            }

            document.getElementById("names").innerHTML = noms;
        }

        function changeMode() {
            searchParams.set("language", selectedLanguage.id);
            searchParams.set("mode", getMode());
            pushNewUrl();
        }

        function changeLanguage(language) {
            if (selectedLanguage == getLanguage(language)) {
                updateNames();
                return;
            }

            let prevModeName = "";
            if (selectedLanguage != null)
                prevModeName = selectedLanguage.modes[getMode()].name;

            selectedLanguage = getLanguage(language);
            document.getElementById("mode").value = 0;
            console.log("Language changed : " + getRequestDescription(language, getMode()));

            if (selectedLanguage == null)
            {
                document.getElementById("currentLanguage").innerHTML = "Erreur";
                document.getElementById("languageHelp").href = "languages.html";
            }
            else
            {
                document.getElementById("currentLanguage").innerHTML = selectedLanguage.name;
                document.getElementById("languageHelp").href = "languages.html#" + selectedLanguage.id;

                // On rÃ©initialize les modes
                select = document.getElementById("mode");
                while(select.childElementCount > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // On ajoute les modes
                for (let i = 1; i < selectedLanguage.modes.length; i++) {
                    let opt = select.appendChild(document.createElement("option"));
                    opt.innerHTML = selectedLanguage.modes[i].name;
                    opt.value = i;

                    if (selectedLanguage.modes[i].name == prevModeName) {
                        document.getElementById("mode").value = i;
                    }
                }
            }

            pushNewUrl();

            updateNames();
        }

        function getMode() {
            return document.getElementById("mode").value;
        }

        function setupLanguages() {
            languages.forEach(x => addLanguage(x));
        }

        function addLanguage(lang) {
            let langs = document.getElementById("languages");
            let button = langs.appendChild(document.createElement("button"));
            button.setAttribute("onclick", "changeLanguage('" + lang.id + "')");
            button.innerHTML = lang.name;
        }
    </script>
</head>
<body>
    <div id="header">
        <a href="index.html"><span id="title">Bastion</span></a>    <span id="author">par Victor Fanton</span>
        <hr>
    </div>
    <h1 id="currentLanguage">Langue</h1>
    <div id="nameoptions">
        <div id="languages">
        </div>
        </br>
        <select name="mode" id="mode" onchange="updateNames(), changeMode()">
            <option value=0>Default</option>
        </select>
    </div>
    <p id="names">Noms</p>
    <div style="text-align: center;">
        <a id="languageHelp" href="languages.html" target="_blank" rel="noopener noreferrer">Aide de prononciation</a>
    </div>
</body>
<script>
    setupLanguages();
    if (searchParams.has("language")) {
        changeLanguage(searchParams.get("language"));
    } else {
        changeLanguage(getRandomLanguage().id);
    }
    
    if (searchParams.has("mode")) {
        document.getElementById("mode").value = searchParams.get("mode");
        pushNewUrl();
    } else {
        document.getElementById("mode").value = 0;
    }
    updateNames();
</script>
</HTML>